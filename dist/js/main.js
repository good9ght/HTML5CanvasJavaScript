class Animacao{constructor(i){this.contexto=i,this.sprites=[],this.ligado=!1,this.processamentos=[],this.spritesExcluir=[],this.processamentosExcluir=[],this.ultimoCiclo=0,this.tempoDecorrido=0}novoSprite(i){this.sprites.push(i),i.animacao=this}novoProcessamento(i){this.processamentos.push(i),i.animacao=this}ligar(){this.ultimoCiclo=0,this.ligado=!0,this.proximoFrame()}desligar(){this.ligado=!1}proximoFrame(){if(!this.ligado)return;let i=(new Date).getTime();0==this.ultimoCiclo&&(this.ultimoCiclo=i),this.decorrido=i-this.ultimoCiclo;for(let i in this.sprites)this.sprites[i].atualizar();for(let i in this.sprites)this.sprites[i].desenhar();for(let i in this.processamentos)this.processamentos[i].processar();this.processarExclusoes(),this.ultimoCiclo=i,requestAnimationFrame(()=>{this.proximoFrame()})}excluirSprite(i){this.spritesExcluir.push(i)}excluirProcessamento(i){this.processamentosExcluir.push(sprite)}processarExclusoes(){let i=[],t=[];for(let t in this.sprites)-1==this.spritesExcluir.indexOf(this.sprites[t])&&i.push(this.sprites[t]);for(let i in this.processamentos)-1==this.processamentosExcluir.indexOf(this.processamentos[i])&&t.push(this.processamentos[i]);this.spritesExcluir=[],this.processamentosExcluir=[],this.sprites=i,this.processamentos=t}}class Colisor{constructor(){this.sprites=[],this.spritesExcluir=[],this.aoColidir=null}novoSprite(i){this.sprites.push(i),i.colisor=this}processar(){let i=new Object;for(let t in this.sprites)for(let s in this.sprites){if(t==s)continue;let o=this.stringUnica(this.sprites[t]),a=this.stringUnica(this.sprites[s]);i[o]||(i[o]=[]),i[a]||(i[a]=[]),i[o].indexOf(a)>=0||i[a].indexOf(o)>=0||(this.testarColisao(this.sprites[t],this.sprites[s]),i[o].push(a),i[a].push(o))}this.processarExclusoes()}testarColisao(i,t){let s=i.retangulosColisao(),o=t.retangulosColisao();i:for(let a in s)for(let e in o)if(this.retangulosColidem(s[a],o[e])){i.colidiuCom(t),t.colidiuCom(i),this.aoColidir&&this.aoColidir(i,t);break i}}retangulosColidem(i,t){return i.x+i.largura>t.x&&i.x<t.x+t.largura&&i.y+i.altura>t.y&&i.y<t.y+t.altura}stringUnica(i){let t=1,s=i.retangulosColisao();for(let i in s)t+="x:"+s[i].x+",y:"+s[i].y+",l:"+s[i].largura+",a:"+s[i].altura+"\n";return t}excluirSprite(i){this.spritesExcluir.push(i)}processarExclusoes(){let i=[];for(let t in this.sprites)-1==this.spritesExcluir.indexOf(this.sprites[t])&&i.push(this.sprites[t]);this.spritesExcluir=[],this.sprites=i}}const SOM_EXPLOSAO=new Audio;SOM_EXPLOSAO.src="dist/snd/explosao.mp3",SOM_EXPLOSAO.volume=0,SOM_EXPLOSAO.load();class Explosao{constructor(i,t,s,o){this.spritesheet=new Spritesheet(i,t,1,5),this.spritesheet.intervalo=75,this.x=s,this.y=o,this.fimDaExplosao=null;var a=this;this.spritesheet.fimDoCliclo=function(){a.animacao.excluirSprite(a),a.fimDaExplosao&&a.fimDaExplosao()},SOM_EXPLOSAO.currentTime=0,SOM_EXPLOSAO.play()}atualizar(){}desenhar(){this.spritesheet.desenhar(this.x,this.y),this.spritesheet.proximoQuadro()}}class Fundo{constructor(i,t){this.contexto=i,this.imagem=t,this.velocidade=0,this.posicaoEmenda=0}atualizar(){this.posicaoEmenda+=this.velocidade*(this.animacao.decorrido/1e3),this.posicaoEmenda>this.imagem.height&&(this.posicaoEmenda=0)}desenhar(){let i=this.imagem,t=this.posicaoEmenda-i.height;this.contexto.drawImage(i,0,t,i.width,i.height),t=this.posicaoEmenda,this.contexto.drawImage(i,0,t,i.width,i.height)}}class Nave{constructor(i,t,s,o){this.contexto=i,this.teclado=t,this.imagem=s,this.x=0,this.y=0,this.velocidade=0,this.spritesheet=new Spritesheet(i,s,3,2),this.spritesheet.linha=0,this.spritesheet.intervalo=100,this.imgExplosao=o,this.acabaramVidas=null,this.vidas=3,this.imgWidth=36,this.imgHeght=48}atualizar(){let i=this.velocidade*this.animacao.decorrido/1e3;this.teclado.pressionada(SETA_ESQUERDA)&&this.x>0&&(this.x-=i),this.teclado.pressionada(SETA_DIREITA)&&this.x<this.contexto.canvas.width-this.imgWidth&&(this.x+=i),this.teclado.pressionada(SETA_ACIMA)&&this.y>0&&(this.y-=i),this.teclado.pressionada(SETA_ABAIXO)&&this.y<this.contexto.canvas.height-this.imgHeght&&(this.y+=i)}desenhar(){this.teclado.pressionada(SETA_ESQUERDA)?this.spritesheet.linha=1:this.teclado.pressionada(SETA_DIREITA)?this.spritesheet.linha=2:this.spritesheet.linha=0,this.spritesheet.desenhar(this.x,this.y),this.spritesheet.proximoQuadro()}atirar(){let i=new Tiro(this.contexto,this.teclado,this);this.animacao.novoSprite(i),this.colisor.novoSprite(i)}retangulosColisao(){return[{x:this.x+2,y:this.y+19,largura:9,altura:13},{x:this.x+13,y:this.y+3,largura:10,altura:33},{x:this.x+25,y:this.y+19,largura:9,altura:13}]}colidiuCom(i){if(i instanceof Ovni){let t=this;this.animacao.excluirSprite(i),this.colisor.excluirSprite(i),this.animacao.excluirSprite(t),this.colisor.excluirSprite(t);let s=new Explosao(this.contexto,this.imgExplosao,i.x,i.y),o=new Explosao(this.contexto,this.imgExplosao,this.x,this.y);this.animacao.novoSprite(s),this.animacao.novoSprite(o),s.fimDaExplosao=function(){t.vidas--,t.vidas<0?t.acabaramVidas&&t.acabaramVidas():(t.animacao.novoSprite(t),t.colisor.novoSprite(t),t.posicionar())}}}posicionar(){this.x=this.contexto.canvas.width/2-18,this.y=this.contexto.canvas.height-48}}class Ovni{constructor(i,t,s){this.imagem=i,this.contexto=t,this.x=0,this.y=0,this.velocidade=0,this.imgExplosao=s}atualizar(){this.y+=this.velocidade*(this.animacao.decorrido/1e3),this.y>this.contexto.canvas.height&&(this.animacao.excluirSprite(this),this.colisor.excluirSprite(this))}desenhar(){this.contexto.drawImage(this.imagem,this.x,this.y,this.imagem.width,this.imagem.height)}retangulosColisao(){return[{x:this.x+20,y:this.y+1,largura:25,altura:10},{x:this.x+2,y:this.y+11,largura:60,altura:12},{x:this.x+20,y:this.y+23,largura:25,altura:7}]}colidiuCom(i){if(i instanceof Tiro){this.animacao.excluirSprite(this),this.colisor.excluirSprite(this),this.animacao.excluirSprite(i),this.colisor.excluirSprite(i);let t=new Explosao(this.contexto,this.imgExplosao,this.x,this.y);this.animacao.novoSprite(t)}}}class Painel{constructor(i,t){this.contexto=i,this.nave=t,this.pontuacao=0,this.spritesheet=new Spritesheet(i,t.imagem,3,2),this.spritesheet.linha=0,this.spritesheet.coluna=0}atualizar(){}desenhar(){this.contexto.scale(.5,.5);let i=20;for(let t=1;t<=this.nave.vidas;t++)this.spritesheet.desenhar(i,20),i+=40;this.contexto.scale(2,2),this.contexto.save(),this.contexto.fillStyle="white",this.contexto.font="18px sans-serif",this.contexto.fillText(this.pontuacao,100,27),this.contexto.restore()}}class Spritesheet{constructor(i,t,s,o){this.contexto=i,this.imagem=t,this.linhas=s,this.colunas=o,this.intervalo=0,this.linha=0,this.coluna=0,this.fimDoCliclo=null}proximoQuadro(){let i=(new Date).getTime();this.ultimoTempo||(this.ultimoTempo=i),i-this.ultimoTempo<this.intervalo||(this.coluna<this.colunas-1?this.coluna++:(this.coluna=0,this.fimDoCliclo&&this.fimDoCliclo()),this.ultimoTempo=i)}desenhar(i,t){let s=this.imagem.width/this.colunas,o=this.imagem.height/this.linhas;this.contexto.drawImage(this.imagem,s*this.coluna,o*this.linha,s,o,i,t,s,o)}}let musicaAcao,animacao,teclado,fundoEspaco,fundoNuvens,fundoEstrelas,nave,colisor,criadorInimigos,painel,canvas=document.querySelector("#meu-canvas"),contexto=canvas.getContext("2d"),imagens={espaco:"dist/img/fundo-espaco.png",estrelas:"dist/img/fundo-estrelas.png",nuvens:"dist/img/fundo-nuvens.png",nave:"dist/img/nave-spritesheet.png",ovni:"dist/img/ovni.png",explosao:"dist/img/explosao.png"},imagensCarregadas=0,totalImagens=0;function carregarImagens(){console.log("tes2te39");for(let i in imagens){let t=new Image;t.src=imagens[i],t.onload=carregando,totalImagens++,imagens[i]=t}}function carregarMusicas(){(musicaAcao=new Audio).src="dist/snd/musica-acao.mp3",musicaAcao.load(),musicaAcao.volume=0,musicaAcao.loop=!0}function carregando(){contexto.save(),contexto.drawImage(imagens.espaco,0,0,canvas.width,canvas.height),contexto.fillStyle="white",contexto.strokeStyle="black",contexto.font="50px sans-serif",contexto.fillText("Loading...",150,200),contexto.strokeText("Loading...",150,200);let i=++imagensCarregadas/totalImagens*300;contexto.fillStyle="yellow",contexto.fillRect(100,250,i,50),contexto.restore(),imagensCarregadas==totalImagens&&(iniciarObjetos(),mostrarLinkJogar())}function iniciarObjetos(){animacao=new Animacao(contexto),teclado=new Teclado(document),colisor=new Colisor,fundoEspaco=new Fundo(contexto,imagens.espaco),fundoEstrelas=new Fundo(contexto,imagens.estrelas),fundoNuvens=new Fundo(contexto,imagens.nuvens),nave=new Nave(contexto,teclado,imagens.nave,imagens.explosao),painel=new Painel(contexto,nave),animacao.novoSprite(fundoEspaco),animacao.novoSprite(fundoEstrelas),animacao.novoSprite(fundoNuvens),animacao.novoSprite(painel),animacao.novoSprite(nave),colisor.novoSprite(nave),animacao.novoProcessamento(colisor),configuracoesIniciais()}function configuracoesIniciais(){fundoEspaco.velocidade=60,fundoNuvens.velocidade=150,fundoEstrelas.velocidade=500,nave.posicionar(),nave.velocidade=200,nave.acabaramVidas=function(){animacao.desligar(),gameOver()},colisor.aoColidir=function(i,t){(i instanceof Tiro&&t instanceof Ovni||i instanceof Ovni&&t instanceof Tiro)&&(painel.pontuacao+=10)},gerarInimigos()}function gerarInimigos(){criadorInimigos={ultimoOvni:(new Date).getTime(),processar:function(){let i=(new Date).getTime();decorrido=i-this.ultimoOvni,decorrido>1e3&&(novoOvni(),this.ultimoOvni=i)}},animacao.novoProcessamento(criadorInimigos)}function pausarJogo(){animacao.ligado?(animacao.desligar(),ativarTiro(!1),musicaAcao.pause(),contexto.save(),contexto.fillStyle="white",contexto.strokeStyle="black",contexto.font="50px sans-serif",contexto.fillText("Pause",160,200),contexto.strokeText("Pause",160,200),contexto.restore()):(criadorInimigos.ultimoOvni=new Date,ativarTiro(!0),animacao.ligar(),musicaAcao.play())}function ativarTiro(i){i?teclado.disparou(ESPACO,function(){nave.atirar()}):teclado.disparou(ESPACO,null)}function novoOvni(){let i=imagens.ovni,t=new Ovni(i,contexto,imagens.explosao);t.velocidade=Math.floor(500+16*Math.random()),t.x=Math.floor(Math.random()*(canvas.width-i.width+1)),t.y=-i.height,animacao.novoSprite(t),colisor.novoSprite(t)}function mostrarLinkJogar(){document.querySelector("#botao-start").style.display="block"}function esconderLinkJogar(){document.querySelector("#botao-start").style.display="none"}function startGame(){criadorInimigos.ultimoOvni=(new Date).getTime(),esconderLinkJogar(),musicaAcao.play(),animacao.ligar(),ativarTiro(!0),painel.pontuacao=0,teclado.disparou(ENTER,pausarJogo),teclado.disparou(SHIFT,function(){teclado.disparou(IGUAL,function(){nave.vidas++}),teclado.disparou(MENOS,function(){nave.vidas>0&&nave.vidas--})})}function gameOver(){ativarTiro(!1),teclado.disparou(ENTER,null),musicaAcao.pause(),musicaAcao.currentTime=0,removerInimigos().then(()=>{contexto.drawImage(imagens.espaco,0,0,canvas.width,canvas.height),contexto.save(),contexto.fillStyle="white",contexto.strokeStyle="black",contexto.font="70px sans-serif",contexto.fillText("SE FODEU",70,200),contexto.strokeText("SE FODEU",70,200),contexto.restore(),mostrarLinkJogar()}),nave.vidas=3,nave.posicionar,animacao.novoSprite(nave),colisor.novoSprite(nave)}function removerInimigos(){return new Promise((i,t)=>{for(let t in animacao.sprites)animacao.sprites[t]instanceof Ovni&&animacao.excluirSprite(animacao.sprites[t]),t==animacao.sprites.length-1&&i()})}function iniciar(){carregarMusicas(),carregarImagens()}const SETA_ESQUERDA=65,SETA_DIREITA=68,SETA_ACIMA=87,SETA_ABAIXO=83,ESPACO=32,SHIFT=16,ENTER=13,IGUAL=187,MENOS=189;class Teclado{constructor(i){this.elemento=i,this.pressionadas=[],this.disparadas=[],this.funcoesDisparo=[];let t=this;i.addEventListener("keydown",function(i){let s=i.keyCode;t.pressionadas[s]=!0,t.funcoesDisparo[s]&&!t.disparadas[s]&&(t.disparadas[s]=!0,t.funcoesDisparo[s]())}),i.addEventListener("keyup",function(i){let s=i.keyCode;t.pressionadas[s]=!1,t.disparadas[s]=!1})}pressionada(i){return this.pressionadas[i]}disparou(i,t){this.funcoesDisparo[i]=t}}const SOM_TIRO=new Audio;SOM_TIRO.src="dist/snd/tiro.mp3",SOM_TIRO.volume=0,SOM_TIRO.load();class Tiro{constructor(i,t,s){this.contexto=i,this.nave=s,this.teclado=t,this.cor="yellow",this.largura=4,this.altura=15,this.x=s.x+18,this.y=s.y-this.altura,this.velocidadePadrao=500,this.velocidadePadrao,this.velocidadeY=this.velocidadePadrao,this.velocidadeX=0,this.executar(),SOM_TIRO.currentTime=0,SOM_TIRO.play()}atualizar(){this.y-=this.velocidadeY*(this.animacao.decorrido/1e3),this.x-=this.velocidadeX*(this.animacao.decorrido/1e3),this.y<-this.altura&&(this.animacao.excluirSprite(this),this.colisor.excluirSprite(this))}desenhar(){let i=this.contexto;i.save(),i.fillStyle=this.cor,i.fillRect(this.x,this.y,this.largura,this.altura),i.restore()}retangulosColisao(){return[{x:this.x,y:this.y,largura:this.largura,altura:this.altura}]}executar(){this.teclado.pressionada(SETA_ESQUERDA)&&(this.teclado.pressionada(SETA_ACIMA)?this.velocidadeX=this.velocidadePadrao:this.teclado.pressionada(SETA_ABAIXO)?this.velocidadeX=-this.velocidadePadrao:this.teclado.pressionada(SHIFT)&&(this.velocidadeY=0,this.velocidadeX=this.velocidadePadrao,this.largura=20,this.altura=4,this.x=nave.x-2,this.y=nave.y- -2*this.altura)),this.teclado.pressionada(SETA_DIREITA)&&(this.teclado.pressionada(SETA_ACIMA)?this.velocidadeX=-this.velocidadePadrao:this.teclado.pressionada(SETA_ABAIXO)?this.velocidadeX=+this.velocidadePadrao:this.teclado.pressionada(SHIFT)&&(this.velocidadeY=0,this.velocidadeX=-this.velocidadePadrao,this.largura=20,this.altura=4,this.x=nave.x+18,this.y=nave.y- -2*this.altura))}colidiuCom(){}}